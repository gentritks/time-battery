<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time & Battery</title>
  <meta name="description" content="Large clock with battery status and class countdowns for kiosk mode." />
  <style>
    :root{
      --bg:#0b0f14; --fg:#e6eef7; --muted:#9db0c0;
      --ok:#29c759; --warn:#f5a524; --crit:#ff3b30; --accent:#4da3ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
      display:flex;align-items:center;justify-content:center;padding:4vh 4vw;
    }
    .wrap{width:min(1100px,100%);text-align:center}
    .time{font-weight:700;letter-spacing:.02em;line-height:1}
    .time .clock{font-size:clamp(48px,16vw,160px)}
    .time .date{margin-top:.4rem;font-size:clamp(18px,3.8vw,28px);color:var(--muted)}

    .grid{display:grid;grid-template-columns:1fr;gap:22px;margin-top:36px}
    @media (min-width:700px){.grid{grid-template-columns:1fr 1fr}}

    .card{background:#101722;border:1px solid #1b2330;border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .label{text-transform:uppercase;font-size:12px;letter-spacing:.14em;color:var(--muted);margin-bottom:8px}

    /* Battery visuals */
    .battery{margin-inline:auto;width:clamp(240px,40vw,420px);height:120px;position:relative;display:flex;align-items:center;justify-content:center}
    .battery svg{width:100%;height:100%;display:block}
    .percent{font-size:clamp(24px,4.2vw,40px);font-weight:700}
    .status{margin-top:4px;color:var(--muted);font-size:14px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .hidden{display:none!important}

    /* Countdown visuals */
    .row{display:flex;align-items:center;gap:10px;justify-content:center}
    .count-meta{font-size:16px;line-height:1.6;color:var(--muted)}
    .countdown-big{font-size:clamp(32px,6vw,80px);font-weight:800;line-height:1.1;margin-top:4px}
    .pbar{position:relative;margin-top:14px;height:14px;background:#132033;border:1px solid #1b2330;border-radius:999px;overflow:hidden}
    .pfill{height:100%;width:0%;background:linear-gradient(90deg,#4da3ff,#29c759)}
    .pcent{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:12px;color:#e6eef7;opacity:.9}

    /* Bell icon + animation for last 30s */
    .bell{width:28px;height:28px;opacity:.85}
    .ring{animation:ring 1s ease-in-out infinite}
    @keyframes ring{
      0%{transform:rotate(0deg)}
      10%{transform:rotate(18deg)}
      20%{transform:rotate(-14deg)}
      30%{transform:rotate(10deg)}
      40%{transform:rotate(-6deg)}
      50%{transform:rotate(3deg)}
      60%,100%{transform:rotate(0deg)}
    }

    /* Low-battery alert visuals */
    .status.crit{ color: var(--crit); }
    .card.low-battery{
      border-color: var(--crit);
      box-shadow: 0 0 0 0 rgba(255,59,48,.45), 0 10px 30px rgba(0,0,0,.25);
      animation: lowPulse 1.6s ease-in-out infinite;
    }
    @keyframes lowPulse{
      0%{ box-shadow: 0 0 0 0 rgba(255,59,48,.45), 0 10px 30px rgba(0,0,0,.25); }
      70%{ box-shadow: 0 0 0 14px rgba(255,59,48,0), 0 10px 30px rgba(0,0,0,.25); }
      100%{ box-shadow: 0 0 0 0 rgba(255,59,48,0), 0 10px 30px rgba(0,0,0,.25); }
    }

    /* Respect reduced motion preferences */
    @media (prefers-reduced-motion: reduce){
      .ring{ animation: none !important; }
      .card.low-battery{ animation: none !important; }
    }

    .footer{margin-top:28px;color:var(--muted);font-size:12px;opacity:.85}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <section class="time">
      <div class="clock" id="clock">--:--:--</div>
      <div class="date" id="date">Loading date…</div>
    </section>

    <section class="grid">
      <!-- Battery -->
      <div class="card" id="batteryCard">
        <div class="label">Battery</div>
        <div class="battery" aria-label="Battery" role="img">
          <svg viewBox="0 0 520 240" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="10" y="40" width="470" height="160" rx="24" fill="#0c1520" stroke="#273449" stroke-width="8"/>
            <rect x="490" y="85" width="20" height="70" rx="8" fill="#273449"/>
            <clipPath id="clip"><rect x="18" y="48" width="454" height="144" rx="16"/></clipPath>
            <g clip-path="url(#clip)">
              <rect x="18" y="48" width="454" height="144" fill="#132033"/>
              <rect id="fill" x="18" y="48" width="0" height="144" fill="#29c759"/>
            </g>
            <!-- charging bolt overlay -->
            <path id="bolt" class="hidden" d="M270 65 l-50 70 h40 l-20 45 l70 -95 h-40 l20 -45 z" fill="#ffffff" opacity=".9" clip-path="url(#clip)"/>
          </svg>
        </div>
        <div class="percent" id="percent">—%</div>
        <div class="status" id="bStatus">Detecting battery…</div>
        <div class="status hidden" id="unsupported">Battery status isn’t available on this device or in this browser.</div>
        <div class="status crit hidden" id="lowNote">Charge soon</div>
        <div class="sr-only" id="srBattery" aria-live="polite"></div>
      </div>

      <!-- Class Countdowns -->
      <div class="card">
        <div class="label">Class Countdowns</div>
        <div>
          <div class="row">
            <svg id="bell" class="bell hidden" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M12 22a2.5 2.5 0 0 0 2.45-2h-4.9A2.5 2.5 0 0 0 12 22Zm7-6V11a7 7 0 1 0-14 0v5l-2 2v1h20v-1l-2-2Z"/>
            </svg>
            <div class="count-meta" id="nowLine">—</div>
          </div>
          <div class="countdown-big" id="bigTimer">—</div>
          <div class="pbar">
            <div class="pfill" id="pfill"></div>
            <div class="pcent" id="pcent">0%</div>
          </div>
          <div class="count-meta" id="nextLine" style="margin-top:8px;">—</div>
        </div>
      </div>
    </section>

    <div class="footer">
      Tip: Bookmark this page to quickly check your battery and class times in kiosk mode.
      <br/>Note: Class countdowns are for reference and may be inaccurate.
    </div>
  </main>

  <script>
    (function(){
      // ---------- Clock (device time; simple + offline) ----------
      const clockEl = document.getElementById('clock');
      const dateEl  = document.getElementById('date');
      function safeFormatter(opts){ try { return new Intl.DateTimeFormat(undefined, opts); } catch(_) { return null; } }
      const fmtTime = safeFormatter({hour:'2-digit', minute:'2-digit', second:'2-digit'});
      const fmtDate = safeFormatter({weekday:'long', year:'numeric', month:'long', day:'numeric'});
      function tickClock(){
        const now = new Date();
        clockEl.textContent = fmtTime ? fmtTime.format(now) : now.toLocaleTimeString();
        dateEl.textContent  = fmtDate ? fmtDate.format(now) : now.toLocaleDateString();
      }
      tickClock();
      setInterval(tickClock, 1000);

      // ---------- Battery (robust; handles missing/never-resolving API) ----------
      const fillEl        = document.getElementById('fill');
      const percentEl     = document.getElementById('percent');
      const statusEl      = document.getElementById('bStatus');
      const unsupportedEl = document.getElementById('unsupported');
      const srBattery     = document.getElementById('srBattery');
      const boltEl        = document.getElementById('bolt');
      // Normalize any placeholder mojibake at runtime
      try {
        if (percentEl) percentEl.textContent = '--%';
        if (statusEl) statusEl.textContent = 'Detecting battery…';
        if (unsupportedEl) unsupportedEl.textContent = 'Battery status isn\u2019t available on this device or in this browser.';
      } catch(_) {}

      function setFill(pct){
        const w = Math.max(0, Math.min(454 * (pct/100), 454));
        fillEl.setAttribute('width', w);
        let varName = '--ok';
        if (pct <= 20) varName = '--crit';
        else if (pct <= 40) varName = '--warn';
        const color = getComputedStyle(document.documentElement).getPropertyValue(varName) || '#29c759';
        fillEl.setAttribute('fill', color.trim());
      }
      function humanTime(sec){
        if (!isFinite(sec) || sec < 0) return '—';
        const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60);
        return (h>0 ? h+'h ' : '') + m + 'm';
      }
      async function initBattery(){
        if (!('getBattery' in navigator)) {
          unsupportedEl.classList.remove('hidden');
          statusEl.classList.add('hidden');
          return;
        }
        let rendered = false;
        const watchdog = setTimeout(() => {
          if (!rendered) {
            unsupportedEl.classList.remove('hidden');
            statusEl.classList.add('hidden');
          }
        }, 5000); // if promise never resolves in kiosk builds

        try {
          const battery = await navigator.getBattery();
          function render(){
            rendered = true;
            const pct = Math.round(battery.level * 100);
            percentEl.textContent = pct + '%';
            setFill(pct);
            boltEl.classList.toggle('hidden', !battery.charging);
            const timeStr = battery.charging
              ? (battery.chargingTime === Infinity ? '' : ('· full in ' + humanTime(battery.chargingTime)))
              : (battery.dischargingTime === Infinity ? '' : ('· left ' + humanTime(battery.dischargingTime)));
            statusEl.textContent = (battery.charging ? 'Charging ' : 'On battery ') + timeStr;
            // Normalize wording and add low-battery UI
            try {
              const fixed = battery.charging
                ? (battery.chargingTime === Infinity ? 'Charging' : ('Charging until full ' + humanTime(battery.chargingTime)))
                : ('On battery ' + (battery.dischargingTime === Infinity ? '' : ('remaining ' + humanTime(battery.dischargingTime))));
              statusEl.textContent = fixed.trim();
              const pct = Math.round(battery.level * 100);
              const batteryCard = document.getElementById('batteryCard');
              const lowNoteEl = document.getElementById('lowNote');
              const isLow = pct <= 20 && !battery.charging;
              if (batteryCard) batteryCard.classList.toggle('low-battery', isLow);
              if (lowNoteEl) lowNoteEl.classList.toggle('hidden', !isLow);
            } catch(_) {}
            srBattery.textContent = `Battery ${pct} percent ${battery.charging ? 'and charging' : ''}`;
            unsupportedEl.classList.add('hidden');
            statusEl.classList.remove('hidden');
          }
          render();
          battery.addEventListener('levelchange', render);
          battery.addEventListener('chargingchange', render);
          battery.addEventListener('chargingtimechange', render);
          battery.addEventListener('dischargingtimechange', render);
        } catch (e) {
          console.error('Battery API error', e);
          unsupportedEl.classList.remove('hidden');
          statusEl.classList.add('hidden');
        } finally {
          clearTimeout(watchdog);
        }
      }
      initBattery();

      // ---------- Class Countdowns (Mon–Thu vs Friday) ----------
      // Mon–Thu
      const weekdaySchedule = [
        {name:'Homeroom', start:'08:00', end:'08:15'},
        {name:'1st Block', start:'08:20', end:'09:25'},
        {name:'2nd Block', start:'09:30', end:'10:35'},
        {name:'3rd Block', start:'10:40', end:'11:45'},
        {name:'4th Block', start:'11:45', end:'12:20'},
        {name:'5th Block', start:'12:25', end:'13:30'},
        {name:'6th Block', start:'13:35', end:'14:45'},
      ];
      // Friday (no “day ends after this block” text—intentionally left blank)
      const fridaySchedule = [
        {name:'Homeroom', start:'08:00', end:'08:15'},
        {name:'1st Block', start:'08:20', end:'09:25'},
        {name:'2nd Block', start:'09:30', end:'10:35'},
        {name:'3rd Block', start:'10:40', end:'11:35'},
      ];

      const nowLineEl = document.getElementById('nowLine');
      const bigTimerEl = document.getElementById('bigTimer');
      const nextLineEl = document.getElementById('nextLine');
      const pfillEl = document.getElementById('pfill');
      const pcentEl = document.getElementById('pcent');
      const bellEl = document.getElementById('bell');

      function parseHM(hm){
        const [H,M] = hm.split(':').map(Number);
        const d = new Date();
        d.setHours(H, M, 0, 0);
        return d;
      }
      function humanClock(ms){
        if (ms <= 0) return '00:00';
        const t = Math.floor(ms/1000), h = Math.floor(t/3600), m = Math.floor((t%3600)/60), s = t%60;
        const pad = n => String(n).padStart(2,'0');
        return (h>0 ? pad(h)+':' : '') + pad(m)+':'+pad(s);
      }

      function updateCountdowns(){
        const now = new Date();
        const sched = (now.getDay() === 5) ? fridaySchedule : weekdaySchedule; // 0 Sun .. 6 Sat

        let active = null, next = null;
        for (let i=0;i<sched.length;i++){
          const s = parseHM(sched[i].start), e = parseHM(sched[i].end);
          if (now >= s && now < e) {
            active = { ...sched[i], s, e };
            next = sched[i+1] ? { ...sched[i+1], s: parseHM(sched[i+1].start) } : null;
            break;
          }
          if (now < s) { next = { ...sched[i], s }; break; }
        }

        if (active){
          const total = active.e - active.s;
          const left  = active.e - now;
          const done  = Math.max(0, Math.min(1, (now - active.s) / total));
          nowLineEl.textContent = `${active.name} ends in`;
          bigTimerEl.textContent = humanClock(left);
          pfillEl.style.width = (done*100).toFixed(1) + '%';
          pcentEl.textContent = Math.round(done*100) + '%';
          nextLineEl.textContent = next
            ? `Next: ${next.name} at ${next.s.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`
            : ''; // no “day ends…” text by request

          // Bell in last 30s
          if (left > 0 && left <= 30000) {
            bellEl.classList.remove('hidden');
            bellEl.classList.add('ring');
          } else {
            bellEl.classList.add('hidden');
            bellEl.classList.remove('ring');
          }
        } else if (next){
          const until = next.s - now;
          nowLineEl.textContent = `${next.name} starts in`;
          bigTimerEl.textContent = humanClock(until);
          pfillEl.style.width = '0%';
          pcentEl.textContent = '0%';
          nextLineEl.textContent = `Starts at ${next.s.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
          bellEl.classList.add('hidden');
          bellEl.classList.remove('ring');
        } else {
          nowLineEl.textContent = 'No active classes';
          bigTimerEl.textContent = '—';
          bigTimerEl.textContent = '--:--';
          pfillEl.style.width = '100%';
          pcentEl.textContent = '100%';
          nextLineEl.textContent = '';
          bellEl.classList.add('hidden');
          bellEl.classList.remove('ring');
        }
      }
      // Enhanced countdown: weekends/after-school show next school start
      function updateCountdownsSchoolAware(){
        const now = new Date();
        const getSchedFor = (d) => {
          const wd = d.getDay();
          if (wd === 5) return fridaySchedule;
          if (wd >= 1 && wd <= 4) return weekdaySchedule;
          return [];
        };
        const combine = (d, hm) => { const [H,M] = hm.split(':').map(Number); const c = new Date(d); c.setHours(H,M,0,0); return c; };
        const prevSchoolDate = (d) => { const c=new Date(d); c.setHours(0,0,0,0); do{ c.setDate(c.getDate()-1);} while(getSchedFor(c).length===0); return c; };
        const nextSchoolDate = (d) => { const c=new Date(d); c.setHours(0,0,0,0); do{ c.setDate(c.getDate()+1);} while(getSchedFor(c).length===0); return c; };

        const sched = getSchedFor(now);
        let active = null, next = null;
        for (let i=0;i<sched.length;i++){
          const s = parseHM(sched[i].start), e = parseHM(sched[i].end);
          if (now >= s && now < e) { active = { ...sched[i], s, e }; next = sched[i+1] ? { ...sched[i+1], s: parseHM(sched[i+1].start) } : null; break; }
          if (now < s) { next = { ...sched[i], s }; break; }
        }

        if (active){
          const total = active.e - active.s;
          const left  = active.e - now;
          const done  = Math.max(0, Math.min(1, (now - active.s) / total));
          nowLineEl.textContent = `${active.name} ends in`;
          bigTimerEl.textContent = humanClock(left);
          pfillEl.style.width = (done*100).toFixed(1) + '%';
          pcentEl.textContent = Math.round(done*100) + '%';
          nextLineEl.textContent = next ? `Next: ${next.name} at ${next.s.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` : '';
          if (left > 0 && left <= 30000) { bellEl.classList.remove('hidden'); bellEl.classList.add('ring'); }
          else { bellEl.classList.add('hidden'); bellEl.classList.remove('ring'); }
          return;
        }

        if (next && sched.length){
          const until = next.s - now;
          nowLineEl.textContent = `${next.name} starts in`;
          bigTimerEl.textContent = humanClock(until);
          pfillEl.style.width = '0%';
          pcentEl.textContent = '0%';
          nextLineEl.textContent = `Starts at ${next.s.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
          bellEl.classList.add('hidden');
          bellEl.classList.remove('ring');
          return;
        }

        // Weekend or after-school
        const lastSchool = prevSchoolDate(now);
        const todayEnd = sched.length ? combine(now, sched[sched.length-1].end) : null;
        const nextSchool = (sched.length && todayEnd && now < todayEnd) ? now : nextSchoolDate(now);
        const nextSched  = getSchedFor(nextSchool);
        const prevSched  = getSchedFor(lastSchool);
        const prevEnd  = combine(lastSchool, prevSched[prevSched.length-1].end);
        const nextStart = combine(nextSchool, nextSched[0].start);
        const until = nextStart - now;
        const total = nextStart - prevEnd;
        const done  = Math.max(0, Math.min(1, (now - prevEnd) / total));
        nowLineEl.textContent = 'School starts in';
        bigTimerEl.textContent = humanClock(until);
        pfillEl.style.width = (done*100).toFixed(1) + '%';
        pcentEl.textContent = Math.round(done*100) + '%';
        const weekdayName = nextStart.toLocaleDateString([], {weekday:'long'});
        const timeStr = nextStart.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        nextLineEl.textContent = `Starts ${weekdayName} ${timeStr}`;
        if (until > 0 && until <= 30000) { bellEl.classList.remove('hidden'); bellEl.classList.add('ring'); }
        else { bellEl.classList.add('hidden'); bellEl.classList.remove('ring'); }
      }

      updateCountdownsSchoolAware();
      setInterval(updateCountdownsSchoolAware, 1000);

      // ---------- Wake Lock (screen) ----------
      async function requestWakeLock(){
        try{
          if (!('wakeLock' in navigator)) return;
          await navigator.wakeLock.request('screen');
          document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') {
              try { await navigator.wakeLock.request('screen'); } catch(_) {}
            }
          });
        } catch(_) {}
      }
      requestWakeLock();
    })();
  </script>
</body>
</html>
