<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time & Battery</title>
  <meta name="description" content="Large clock with battery status for kiosk mode." />
  <style>
    :root{
      --bg: #0b0f14;
      --fg: #e6eef7;
      --muted: #9db0c0;
      --ok: #29c759;
      --warn: #f5a524;
      --crit: #ff3b30;
      --accent: #4da3ff;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0; background: var(--bg); color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display:flex; align-items:center; justify-content:center; padding: 4vh 4vw;
    }
    .wrap{ width:min(1100px, 100%); text-align:center; }
    .time{ font-weight: 700; letter-spacing: 0.02em; line-height:1; }
    .time .clock{ font-size: clamp(48px, 16vw, 160px); }
    .time .date{ margin-top: .4rem; font-size: clamp(18px, 3.8vw, 28px); color: var(--muted); }

    .grid{ display:grid; grid-template-columns: 1fr; gap: 22px; margin-top: 36px; }
    @media (min-width: 700px){ .grid{ grid-template-columns: 1fr 1fr; } }

    .card{ background: #101722; border: 1px solid #1b2330; border-radius: 16px; padding: 22px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .label{ text-transform: uppercase; font-size: 12px; letter-spacing:.14em; color: var(--muted); margin-bottom:8px; }

    .battery{ margin-inline:auto; width: clamp(240px, 40vw, 420px); height: 120px; position:relative; display:flex; align-items:center; justify-content:center; }
    .battery svg{ width:100%; height:100%; display:block; }
    .percent{ font-size: clamp(24px, 4.2vw, 40px); font-weight: 700; }
    .status{ margin-top:4px; color: var(--muted); font-size: 14px; }

    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    .footer{ margin-top: 28px; color: var(--muted); font-size: 12px; opacity:.85; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <section class="time" aria-live="polite">
      <div class="clock" id="clock">--:--:--</div>
      <div class="date" id="date">Loading date…</div>
    </section>

    <section class="grid" aria-live="polite">
      <div class="card">
        <div class="label">Battery</div>
        <div class="battery" aria-label="Battery" role="img">
          <svg viewBox="0 0 520 240" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="10" y="40" width="470" height="160" rx="24" fill="#0c1520" stroke="#273449" stroke-width="8" />
            <rect x="490" y="85" width="20" height="70" rx="8" fill="#273449" />
            <clipPath id="clip">
              <rect x="18" y="48" width="454" height="144" rx="16" />
            </clipPath>
            <g clip-path="url(#clip)">
              <rect x="18" y="48" width="454" height="144" fill="#132033" />
              <rect id="fill" x="18" y="48" width="0" height="144" fill="#29c759" />
            </g>
            <path id="bolt" class="hidden" d="M270 65 l-50 70 h40 l-20 70 l70 -95 h-40 l20 -45 z" fill="#ffffff" opacity="0.9" />
          </svg>
        </div>
        <div class="percent" id="percent">—%</div>
        <div class="status" id="bStatus">Detecting battery…</div>
        <div class="status hidden" id="unsupported">Battery status isn’t available on this device or in this browser.</div>
        <div class="sr-only" id="srBattery" aria-live="polite"></div>
      </div>

      <div class="card">
        <div class="label">Details</div>
        <div id="details" style="font-size:16px; line-height:1.6">
          <div><strong>Timezone:</strong> <span id="tz">—</span></div>
          <div><strong>Local Time:</strong> <span id="lt">—</span></div>
          <div><strong>Last Updated:</strong> <span id="updated">—</span></div>
        </div>
      </div>
    </section>

    <div class="footer">Tip: Bookmark this page so you can quickly check your battery in kiosk mode.</div>
  </main>

  <script>
    (function(){
      const clockEl = document.getElementById('clock');
      const dateEl = document.getElementById('date');
      const fillEl = document.getElementById('fill');
      const percentEl = document.getElementById('percent');
      const statusEl = document.getElementById('bStatus');
      const unsupportedEl = document.getElementById('unsupported');
      const srBattery = document.getElementById('srBattery');
      const tzEl = document.getElementById('tz');
      const ltEl = document.getElementById('lt');
      const updatedEl = document.getElementById('updated');
      const boltEl = document.getElementById('bolt');

      // ------------------ TIME (server-synced with fallback) ------------------
      function safeFormatter(opts){
        try { return new Intl.DateTimeFormat(undefined, opts); }
        catch(_) { return null; }
      }
      const fmtTime = safeFormatter({ hour: '2-digit', minute:'2-digit', second:'2-digit' });
      const fmtDate = safeFormatter({ weekday:'long', year:'numeric', month:'long', day:'numeric' });
      const fmtLong = safeFormatter({ hour: '2-digit', minute:'2-digit', second:'2-digit', hour12: false });

      let offsetMs = 0;           // serverTime - deviceTime
      let usingServer = false;    // whether server time is in use
      let lastProvider = 'Device clock';

      function displayNow(){
        const now = new Date(Date.now() + offsetMs);
        clockEl.textContent = fmtTime ? fmtTime.format(now) : now.toLocaleTimeString();
        dateEl.textContent  = fmtDate ? fmtDate.format(now) : now.toLocaleDateString();
        ltEl.textContent    = fmtLong ? fmtLong.format(now) : now.toLocaleTimeString();
      }

      function setUpdated(){ updatedEl.textContent = new Date().toLocaleTimeString(); }

      function fetchWithTimeout(url, ms){
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), ms);
        return fetch(url, { signal: ctrl.signal, cache: 'no-store' }).finally(() => clearTimeout(t));
      }

      async function getServerTime(){
        const tz = (()=>{ try { return Intl.DateTimeFormat().resolvedOptions().timeZone; } catch(_) { return null; } })();
        const candidates = [
          tz ? `https://worldtimeapi.org/api/timezone/${encodeURIComponent(tz)}` : 'https://worldtimeapi.org/api/ip',
          tz ? `https://timeapi.io/api/Time/current/zone?timeZone=${encodeURIComponent(tz)}` : null,
        ].filter(Boolean);

        for(const url of candidates){
          try{
            const res = await fetchWithTimeout(url, 3500);
            if(!res.ok) continue;
            const data = await res.json();
            // worldtimeapi: data.datetime; timeapi.io: data.dateTime
            const iso = data.datetime || data.dateTime;
            if(!iso) continue;
            const serverDate = new Date(iso);
            if(isNaN(serverDate)) continue;
            // Calculate offset so updates keep ticking without re-fetching each second
            offsetMs = serverDate.getTime() - Date.now();
            usingServer = true;
            lastProvider = new URL(url).hostname;
            return true;
          }catch(_){ /* try next provider */ }
        }
        // Fall back to device clock
        offsetMs = 0;
        usingServer = false;
        lastProvider = 'Device clock';
        return false;
      }

      async function syncClock(){
        const ok = await getServerTime();
        displayNow();
        setUpdated();
        // Announce where time comes from (only visually via Details > Local Time)
        ltEl.title = usingServer ? `Synced with ${lastProvider}` : 'Using device clock';
      }

      // keep display smooth; resync every 10 minutes to correct drift
      setInterval(displayNow, 1000);
      setInterval(syncClock, 10 * 60 * 1000);

      // ------------------ BATTERY ------------------
      function setFill(percent){
        const w = Math.max(0, Math.min(454 * (percent/100), 454));
        fillEl.setAttribute('width', w);
        let cssVar = '--ok';
        if(percent <= 20) cssVar = '--crit';
        else if(percent <= 40) cssVar = '--warn';
        const color = getComputedStyle(document.documentElement).getPropertyValue(cssVar) || '#29c759';
        fillEl.setAttribute('fill', color.trim());
      }

      function humanTime(sec){
        if(!isFinite(sec) || sec < 0) return '—';
        const h = Math.floor(sec/3600);
        const m = Math.floor((sec%3600)/60);
        return (h>0? h+"h ":"") + m + "m";
      }

      async function initBattery(){
        if(!('getBattery' in navigator)){
          unsupportedEl.classList.remove('hidden');
          statusEl.classList.add('hidden');
          return;
        }
        let rendered = false;
        const timeout = setTimeout(() => {
          if(!rendered){
            unsupportedEl.classList.remove('hidden');
            statusEl.classList.add('hidden');
          }
        }, 5000);
        try{
          const battery = await navigator.getBattery();
          function render(){
            rendered = true;
            const pct = Math.round(battery.level * 100);
            percentEl.textContent = pct + '%';
            setFill(pct);
            boltEl.classList.toggle('hidden', !battery.charging);
            const timeStr = battery.charging ? (
              battery.chargingTime === Infinity ? 'calculating…' : ('full in ' + humanTime(battery.chargingTime))
            ) : (
              battery.dischargingTime === Infinity ? 'calculating…' : ('left ' + humanTime(battery.dischargingTime))
            );
            statusEl.textContent = (battery.charging ? 'Charging · ' : 'On battery · ') + timeStr;
            srBattery.textContent = `Battery ${pct} percent ${battery.charging? 'and charging' : ''}`;
            setUpdated();
            unsupportedEl.classList.add('hidden');
            statusEl.classList.remove('hidden');
          }
          render();
          battery.addEventListener('levelchange', render);
          battery.addEventListener('chargingchange', render);
          battery.addEventListener('chargingtimechange', render);
          battery.addEventListener('dischargingtimechange', render);
        }catch(err){
          console.error('Battery API error', err);
          unsupportedEl.classList.remove('hidden');
          statusEl.classList.add('hidden');
        } finally {
          clearTimeout(timeout);
        }
      }

      function initInfo(){
        try{ tzEl.textContent = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local'; }
        catch(_){ tzEl.textContent = 'Local'; }
      }

      // ---- Boot ----
      initInfo();
      syncClock();      // initial server sync (with fallback)
      initBattery();
    })();
  </script>
</body>
</html>
